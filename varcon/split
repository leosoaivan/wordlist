#!/usr/bin/perl

use strict;
use warnings;
use IO::Handle;

use varcon qw(%map);

my %F;

my %lists_pre;

# $cat = 'normal' or 'uncommon'
# $sp = spelling
# $vl = variant_level

my $file = $ARGV[0];
$file = "varcon.txt" unless defined $file;

open F, $file;    
while (<F>) {
    #print;
    next if varcon::filter $_;
    my %notes;
    my %r = varcon::flatten(varcon::readline($_,\%notes));
    my $cat = $notes{uncommon} ? 'uncommon' : 'normal';
    foreach my $k (sort keys %r) {
        #print ">>$k<<\n";
        my ($sp, $vl) = $k =~ /^(.)(.)?$/ or die "Bad: $k";
        $vl = ' ' unless defined $vl;
        foreach my $word (@{$r{$k}}) {
            $lists_pre{$cat}{$sp}{$vl}{$word}++;
        }
    }
}

my %lists;

foreach my $cat (sort keys %lists_pre) {
    foreach my $sp (sort keys %{$lists_pre{$cat}}) {
        my %already_have;
        foreach my $vl (sort keys %{$lists_pre{$cat}{$sp}}) {
            foreach my $word (keys %{$lists_pre{$cat}{$sp}{$vl}}) {
                next if $already_have{$word};
                $already_have{$word}++;
                push @{$lists{$sp}{$vl}}, $word;
            }
        }
    }
}

foreach my $sp (sort keys %lists) {
    my %already_have;
    foreach my $vl (sort keys %{$lists{$sp}}) {
        my $name = $map{$sp};
        $name .= "-v$vl" if $vl ne ' ';
        $name .= ".lst";
        my @words = sort @{$lists{$sp}{$vl}};
        open F, ">$name";
        my $prev = '';
        foreach (@words) {
            next if $_ eq $prev;
            $prev = $_;
            print F "$_\n";
        }
    }
}

